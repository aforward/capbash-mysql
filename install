#!/bin/bash

#-----------
# Configurations
#-----------

MYSQL_LAUNCHER_DIR=${MYSQL_LAUNCHER_DIR-/var/local/mysql}
MYSQL_DATA_DIR=${MYSQL_DATA_DIR-${MYSQL_LAUNCHER_DIR}/data}
MYSQL_PORT=${MYSQL_PORT-3306}
MYSQL_ADMIN_USERNAME=${MYSQL_ADMIN_USERNAME-admin}
MYSQL_ADMIN_PASSWORD=${MYSQL_ADMIN_PASSWORD-yth3fn0t}

#-----------
# Install Script
#-----------

if [[ "`which mysql`" == "" ]]; then
  apt-get install -y mysql-client
fi

mkdir -p ${MYSQL_LAUNCHER_DIR}/helper
mkdir -p $MYSQL_DATA_DIR

cp ./submodules/mysql/files/mysql.dockerfile ${MYSQL_LAUNCHER_DIR}/Dockerfile

# Causing a rebuild in mysql, so only updating if it's new
if [[ ! -e ${MYSQL_LAUNCHER_DIR}/helper/setup_database ]]; then
  cp ./submodules/mysql/files/setup_database ${MYSQL_LAUNCHER_DIR}/helper/setup_database
fi

(cd ${MYSQL_LAUNCHER_DIR} && docker build -t mysql .)
printf "%b" "#!/bin/bash
docker run -i -t -p $MYSQL_PORT:3306 -v $MYSQL_DATA_DIR:/data mysql /bin/bash
" > ${MYSQL_LAUNCHER_DIR}/debug

printf "%b" "#!/bin/bash
echo \"Starting MYSQL ($MYSQL_PORT, $MYSQL_DATA_DIR)...\"
docker rm mysql > /dev/num
docker run -d -t -p $MYSQL_PORT:3306 -v $MYSQL_DATA_DIR:/data --name mysql mysql
IP=\$(${MYSQL_LAUNCHER_DIR}/ip)

if [[ \"\$IP\" == '' ]]; then
  echo 'No IP address assigned when starting MYSQL, not sure what went wrong.'
  exit 1
fi

echo \"DONE, Starting MYSQL $IP ($MYSQL_PORT, $MYSQL_DATA_DIR).\"

if [[ \"\`cat /etc/hosts | grep mysql.local\`\" == '' ]]; then
  echo \"Adding mysql.local (\$IP) to /etc/hosts\"
  echo \"\$IP mysql.local\" >> /etc/hosts
else
  echo \"Updating mysql.local (\$IP) in /etc/hosts\"
  sed -i \"s|.*mysql.local|\$IP mysql.local|g\" /etc/hosts
fi
" > ${MYSQL_LAUNCHER_DIR}/start


printf "%b" "#!/bin/bash
docker run \\
  -e MYSQL_ADMIN_USERNAME=$MYSQL_ADMIN_USERNAME \\
  -e MYSQL_ADMIN_PASSWORD=$MYSQL_ADMIN_PASSWORD \\
  -p 9995:3306 \\
  -v $MYSQL_DATA_DIR:/data \\
  mysql /opt/setup_database
" > ${MYSQL_LAUNCHER_DIR}/init

printf "%b" "#!/bin/bash
IP=\$(${MYSQL_LAUNCHER_DIR}/ip)
if [[ \"\$IP\" == '' ]]; then
  echo 'MYSQL not running (no IP available), cannot connect.'
else
  echo \"Connecting to mysql.local (\$IP) as $MYSQL_ADMIN_USERNAME\"
  mysql -u $MYSQL_ADMIN_USERNAME -p$MYSQL_ADMIN_PASSWORD -h mysql.local
fi
" > ${MYSQL_LAUNCHER_DIR}/connect

printf "%b" "#!/bin/bash
mysql -u $MYSQL_ADMIN_USERNAME -p$MYSQL_ADMIN_PASSWORD -h mysql.local -e \"CREATE DATABASE IF NOT EXISTS \$1\"
" > ${MYSQL_LAUNCHER_DIR}/newdb

NAME=mysql DIR=$MYSQL_LAUNCHER_DIR ./submodules/docker/idempot
NAME=mysql DIR=$MYSQL_LAUNCHER_DIR ./submodules/docker/ip
NAME=mysql HOST=mysql.local DIR=$MYSQL_LAUNCHER_DIR ./submodules/docker/stop

chmod 755 $MYSQL_LAUNCHER_DIR/debug
chmod 755 $MYSQL_LAUNCHER_DIR/start
chmod 755 $MYSQL_LAUNCHER_DIR/connect
chmod 755 $MYSQL_LAUNCHER_DIR/init
chmod 755 $MYSQL_LAUNCHER_DIR/newdb

$MYSQL_LAUNCHER_DIR/init
